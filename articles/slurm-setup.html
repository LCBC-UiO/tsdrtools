<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using R-packages in SLURM scripts • tsdrtools</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using R-packages in SLURM scripts">
<meta property="og:description" content="tsdrtools">
<meta property="og:image" content="/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tsdrtools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.01</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/tsdrtools.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/minicran-tsd-install.html">Installing packages on TSD from mini-CRAN</a>
    </li>
    <li>
      <a href="../articles/rstudio-tsd-install.html">Installing RStudio on TSD</a>
    </li>
    <li>
      <a href="../articles/slurm-setup.html">Using R-packages in SLURM scripts</a>
    </li>
    <li>
      <a href="../articles/tidyverse-tsd-install.html">Installing the Tidyverse on TSD</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/LCBC-UiO/tsdrtools/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using R-packages in SLURM scripts</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/LCBC-UiO/tsdrtools/blob/master/vignettes/slurm-setup.Rmd"><code>vignettes/slurm-setup.Rmd</code></a></small>
      <div class="hidden name"><code>slurm-setup.Rmd</code></div>

    </div>

    
    
<p>TSD is connected to a large computing cluster running a SLURM grid. Information about submitting jobs to the cluster can be found on the UiO <a href="https://www.uio.no/english/services/it/research/sensitive-data/use-tsd/hpc/colossus-userguide.html">TSD webpages</a>. Here we will outline some suggestions and recommendation we have on setting up your Rscripts for running on the grid, based on the experiences we have made.</p>
<p>When you submit a job to the grid, alot of the setup you have in your terminal will not be inherted by the job. This is good, because then you can make sure that your script is reproducible. At the core, you will need two files to submit a job:</p>
<ol style="list-style-type: decimal">
<li>an Rscript (a file containing your entire analysis pipeline)<br>
</li>
<li>a slurm script (that sets up the computing cluster for you)</li>
</ol>
<div id="recommendation-for-the-r-script" class="section level2">
<h2 class="hasAnchor">
<a href="#recommendation-for-the-r-script" class="anchor"></a>Recommendation for the R-script</h2>
<p>When loading libraries in an RScript that will be used on the cluster, we recommend explicitly static the folder where the <em>installed</em> package can be found. For most users, this will be in your home (<code>$HOME</code>) folder, where the cluster actually cannot access it. The cluster nodes need libraries and software (if not using modules) to be stored on the <code>/cluster</code> disk. We recommend that projects create a central repository for project members to use and access when running analyses, or if specific package versions need to be used, to make a system where software and libraries can be stored.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># Create folders to place software and libraries</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="fu">mkdir</span> /cluster/projects/pXXX/tools/</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co"># Create folder for r libraries</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="fu">mkdir</span> -p /cluster/projects/pXXX/tools/r_libs/common</a></code></pre></div>
<p>In the <code>common</code> folder place installed packages that users regularly use and share. Let users create specific own folder within <code>r_libs</code> if there are specific versions of packages they need to use.</p>
<p>Installing packages into specific folders can be done by using the <code>lib</code> argument to `install.packages()``</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"clipr"</span>, <span class="kw">lib</span> <span class="kw">=</span> <span class="st">"/cluster/projects/pXXX/tools/r_libs/common"</span>)</pre></body></html></div>
<p>By doing this, library calls within the Rscript you want to submit to the cluster should be called using the <code>lib.loc</code> argument, giving the folder of the installed package.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">clipr</span>, <span class="kw">lib.loc</span> <span class="kw">=</span> <span class="st">"/cluster/projects/pXXX/tools/r_libs/common"</span>)</pre></body></html></div>
<p>Make sure your analysis outputs files with your analysis results, as tables (<code>write.table</code>) or plain text files (<code>writeLines</code>) or any other output you want to work with later.</p>
<p>We recommend having your Rscript contain alot of either <code><a href="https://rdrr.io/r/base/cat.html">cat()</a></code> or <code><a href="https://rdrr.io/r/base/print.html">print()</a></code> messages, so that you can catch these for debugging if (when) things fails. We also recommend adding a <code><a href="https://rdrr.io/r/base/cat.html">cat(Sys.date())</a></code> command at the beginning and end (and maybe even intermediate places in the script), so your output log can check the amount of time different operations take. Some times things stall, or get stuck for some reason, and a timestamp might help you figure out where that is happening.</p>
</div>
<div id="recommendation-for-the-slurm-script" class="section level2">
<h2 class="hasAnchor">
<a href="#recommendation-for-the-slurm-script" class="anchor"></a>Recommendation for the SLURM script</h2>
<p>We will not cover the settings of the slurm script, these really depend on the analyses you are doing, and as such you should follow the <a href="https://www.uio.no/english/services/it/research/sensitive-data/use-tsd/hpc/job-scripts.html">USIT guide for settings</a>.</p>
<p>Once you have some base settings for your SLURM script in place, you will need to load R as a module <em>before</em> calling your RScript. We recommend always being explicit i which R-version you want to use (modules load a default version, but for reproducibility you should always specify a version, even if it is the default one).</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co">#!/bin/bash</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">#SBATCH --account=pXXX</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co">#SBATCH --time=1:00:00</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">#SBATCH --mem-per-cpu=1G</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co"># Set up job environment:</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="ex">module</span> purge   # clear any inherited modules</a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="ex">module</span> load R/4.0.2</a>
<a class="sourceLine" id="cb4-9" data-line-number="9"></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co"># Run Rscript in a clean R instance, output a logfile</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="ex">Rscript</span> --vanilla --verbose /cluster/projects/pxxx/path/to/myScript.R <span class="op">&gt;</span> slurm-<span class="va">${SLURM_JOBID}</span>.Rout <span class="op">2&gt;&amp;1</span> </a>
<a class="sourceLine" id="cb4-12" data-line-number="12"></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="co"># append logfile to this scripts logfile</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="fu">cat</span> slurm-<span class="va">${SLURM_JOBID}</span>.Rout <span class="op">&gt;&gt;</span> slurm-<span class="va">${SLURM_JOBID}</span>.out</a>
<a class="sourceLine" id="cb4-15" data-line-number="15"></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"><span class="co"># remove Rout log</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="fu">rm</span> slurm-<span class="va">${SLURM_JOBID}</span>.Rout</a></code></pre></div>
<p>This will run your Rscript in a vanilla instance of R, meaning it sets up no environment, profile or the like, it opens R completely clean. This is recommended to keep your script reproducible. It is set to be “verbose” as this means R will be extra vocal when running commands, and we capture that information in a logfile. This makes it easier to understand why your scripts fail when they do.</p>
</div>
<div id="submit-your-job" class="section level2">
<h2 class="hasAnchor">
<a href="#submit-your-job" class="anchor"></a>Submit your job</h2>
<p>Once you have your slurm script ready, and your Rscript ready, you can submit your script to the cluster.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="ex">sbatch</span> /cluster/projects/pxxx/path/to/mySlurm.sh</a></code></pre></div>
<p>Then start debugging what is going wrong. Getting scripts running correctly on TSD can some times require some extra work, but read the slurm logs, and keep fixing the issues as they occur. Submitting a new script rarely works on the first try, we are human after all.</p>
<p>Good luck!</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Athanasia Mo Mowinckel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
